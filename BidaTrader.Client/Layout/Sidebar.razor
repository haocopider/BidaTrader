
@inject NavigationManager Navigation
@code {
    // --- KHAI BÁO BIẾN DỮ LIỆU ---
    private List<CategoryDto>? categories;

    // --- BIẾN TRẠNG THÁI LỌC ---
    private string SearchTerm { get; set; } = "";
    private int? SelectedCategoryId { get; set; }
    private int SelectedPriceRange { get; set; } = 0; // 0: All, 1: <1M, 2: 1-5M, ...
    private decimal MaxPriceSlider { get; set; } = 20000000; // Giá trị mặc định slider

    protected override async Task OnInitializedAsync()
    {
        // Tải danh mục khi Sidebar khởi tạo
        categories = await CategoryService.GetItemsAsync();
    }

    // Xử lý khi nhấn Enter ở ô tìm kiếm
    private void HandleSearchEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") ApplyFilters();
    }

    // Chọn danh mục và áp dụng ngay
    private void SelectCategory(int? id)
    {
        SelectedCategoryId = id;
        ApplyFilters();
    }

    // Chọn khoảng giá và áp dụng ngay
    private void SelectPrice(int rangeOption)
    {
        SelectedPriceRange = rangeOption;
        ApplyFilters();
    }

    // Hàm tổng hợp logic và điều hướng
    private void ApplyFilters()
    {
        var queryParts = new List<string>();

        if (!string.IsNullOrWhiteSpace(SearchTerm))
            queryParts.Add($"search={Uri.EscapeDataString(SearchTerm)}");

        if (SelectedCategoryId.HasValue)
            queryParts.Add($"categoryId={SelectedCategoryId.Value}");

        // Logic xử lý khoảng giá (Backend cần xử lý tham số minPrice/maxPrice)
        switch (SelectedPriceRange)
        {
            case 1: queryParts.Add("maxPrice=1000000"); break;
            case 2: queryParts.Add("minPrice=1000000&maxPrice=5000000"); break;
            case 3: queryParts.Add("minPrice=5000000&maxPrice=10000000"); break;
            case 4: queryParts.Add("minPrice=10000000"); break;
            default:
                // Nếu không chọn range radio thì kiểm tra slider (Logic ưu tiên radio trước)
                if (SelectedPriceRange == 0 && MaxPriceSlider > 0 && MaxPriceSlider < 50000000)
                {
                    queryParts.Add($"maxPrice={MaxPriceSlider}");
                }
                break;
        }

        var queryString = queryParts.Any() ? "?" + string.Join("&", queryParts) : "";

        // Điều hướng sang trang danh sách sản phẩm với bộ lọc
        Navigation.NavigateTo($"/products{queryString}");
    }
}

<aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
    <div class="app-brand demo">
        <a href="" class="app-brand-link">
            <img src="../assets/img/logo.png" alt="Logo" width="50" class="app-brand-logo demo" />
            <span class="app-brand-text demo menu-text fw-bolder ms-2">BidaTrader</span>
        </a>

        <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large ms-auto d-block d-xl-none">
            <i class="bx bx-chevron-left bx-sm align-middle"></i>
        </a>
    </div>

    <div class="menu-inner-shadow"></div>

    <ul class="menu-inner py-1">
        <!-- Dashboard -->
        <li class="menu-item active">
            <a href="admin/dashboard" class="menu-link">
                <i class="menu-icon tf-icons bx bx-home-circle"></i>
                <div data-i18n="Analytics">Trang chủ</div>
            </a>
        </li>

        <!-- Layouts -->
        <AuthorizeView Roles="Admin">
            <Authorized>
                <li class="menu-item">
                    <a href="/admin/dashboard" class="menu-link">
                        <i class="menu-icon tf-icons bx bx-layout"></i>
                        <div data-i18n="Layouts">Trang quản trị</div>
                    </a>

                    <ul class="menu-sub">
                        <li class="menu-item">
                            <a href="layouts-without-menu.html" class="menu-link">
                                <div data-i18n="Without menu">Người dùng</div>
                            </a>
                        </li>
                        <li class="menu-item">
                            <a href="layouts-without-navbar.html" class="menu-link">
                                <div data-i18n="Without navbar">Cửa hàng</div>
                            </a>
                        </li>
                        <li class="menu-item">
                            <a href="layouts-container.html" class="menu-link">
                                <div data-i18n="Container">Sản phẩm</div>
                            </a>
                        </li>
                        <li class="menu-item">
                            <a href="layouts-fluid.html" class="menu-link">
                                <div data-i18n="Fluid">Bài viết</div>
                            </a>
                        </li>
                        <li class="menu-item">
                            <a href="layouts-blank.html" class="menu-link">
                                <div data-i18n="Blank">Phản hồi</div>
                            </a>
                        </li>
                    </ul>
                </li>
            </Authorized>
        </AuthorizeView>

        <AuthorizeView Roles="Store">
            <Authorized>
                <li class="menu-header small text-uppercase">
                    <span class="menu-header-text text-danger">Cửa hàng</span>
                </li>
                <li class="menu-item">
                    <a href="javascript:void(0);" class="menu-link">
                        <i class="menu-icon tf-icons bx bx-package"></i>
                        <div>Sản phẩm</div>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="javascript:void(0);" class="menu-link">
                        <i class="menu-icon tf-icons bx bxs-shopping-bag-alt"></i>
                        <div data-i18n="Authentications">Đơn hàng</div>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="javascript:void(0);" class="menu-link">
                        <i class="menu-icon tf-icons bi bi-clipboard2-data"></i>
                        <div data-i18n="Misc">Thống kê</div>
                    </a>
                </li>

            </Authorized>
        </AuthorizeView>
        
        <AuthorizeView>
            <Authorized>
                <li class="menu-header small text-uppercase"><span class="menu-header-text text-danger">Tài khoản</span></li>
                <!-- Cards -->
                <li class="menu-item">
                    <a href="cards-basic.html" class="menu-link">
                        <i class="menu-icon tf-icons bx bx-user"></i>
                        <div data-i18n="Basic">Trang cá nhân</div>
                    </a>
                </li>
                <!-- User interface -->
                <li class="menu-item">
                    <a href="javascript:void(0)" class="menu-link">
                        <i class="menu-icon tf-icons bx bx-key"></i>
                        <div data-i18n="User interface">Đổi mật khẩu</div>
                    </a>
                </li>
            </Authorized>
        </AuthorizeView>

        <AuthorizeView Roles="Customer">
            <!-- Extended components -->
            <li class="menu-item">
                <a href="javascript:void(0)" class="menu-link menu-toggle">
                    <i class="menu-icon tf-icons bx bxs-shopping-bag-alt"></i>
                    <div> Đơn hàng</div>
                </a>
                <ul class="menu-sub">
                    <li class="menu-item">
                        <a href="extended-ui-perfect-scrollbar.html" class="menu-link">
                            <div data-i18n="Perfect Scrollbar">Chờ xác nhận</div>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="extended-ui-text-divider.html" class="menu-link">
                            <div data-i18n="Text Divider">Chờ lấy hàng</div>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="extended-ui-text-divider.html" class="menu-link">
                            <div data-i18n="Text Divider">Đang giao</div>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="extended-ui-text-divider.html" class="menu-link">
                            <div data-i18n="Text Divider">Đánh giá</div>
                        </a>
                    </li>
                </ul>
            </li>
        </AuthorizeView>

        <li class="menu-header small text-uppercase">
            <span class="menu-header-text text-primary">Tìm kiếm & Lọc</span>
        </li>

        @* 1. THANH TÌM KIẾM *@
        <li class="menu-item">
            <div class="p-2">
                <div class="input-group input-group-merge">
                    <input type="text" class="form-control" placeholder="Tên sản phẩm..."
                           @bind="SearchTerm" @onkeyup="HandleSearchEnter" />
                    <button class="btn btn-primary p-2" @onclick="ApplyFilters">
                        <i class="bx bx-search"></i>
                    </button>
                </div>
            </div>
        </li>

        <li class="menu-item">
            <a href="javascript:void(0);" class="menu-link">
                <i class="menu-icon tf-icons bx bx-money"></i>
                <div data-i18n="Price">Phân khúc</div>
            </a>
            <ul class="">
                <li class="menu-item @(SelectedPriceRange == 1 ? "active" : "")">
                    <a href="javascript:void(0)" class="menu-link" @onclick="() => SelectPrice(1)">  1 - 3 triệu</a>
                </li>
                <li class="menu-item @(SelectedPriceRange == 2 ? "active" : "")">
                    <a href="javascript:void(0)" class="menu-link" @onclick="() => SelectPrice(2)">  3 - 5 triệu</a>
                </li>
                <li class="menu-item @(SelectedPriceRange == 3 ? "active" : "")">
                    <a href="javascript:void(0)" class="menu-link" @onclick="() => SelectPrice(3)"> 5 - 10 triệu</a>
                </li>

                @* Thanh kéo thả (Slider) - Lọc theo giá tối đa *@
                <li class="menu-item p-3">
                    <label for="priceRange" class="form-label small text-muted">Hoặc giá tối đa:</label>
                    <input type="range" class="form-range" id="priceRange"
                           min="0" max="50000000" step="500000"
                           @bind="MaxPriceSlider" @bind:after="ApplyFilters">
                    <div class="text-end small text-primary fw-bold">
                        @MaxPriceSlider.ToString("N0") đ
                    </div>
                </li>
            </ul>
        </li>

    </ul>
</aside>