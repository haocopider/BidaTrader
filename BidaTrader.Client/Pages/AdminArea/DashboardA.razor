@page "/store/product-table"
@attribute [Authorize(Roles = "Store,Admin")]

<h3 class="mb-4">Quản lý Sản phẩm (Phân Trang)</h3>

@if (IsLoading)
{
    <div class="alert alert-info">Đang tải dữ liệu sản phẩm...</div>
}
else if (ErrorMessage != null)
{
    <div class="alert alert-danger">Lỗi: @ErrorMessage</div>
}
else if (PagedProducts?.Items == null || PagedProducts.Items.Count == 0)
{
    <div class="alert alert-warning">Không tìm thấy sản phẩm nào.</div>
}
else
{
    @* --- TABLE HIỂN THỊ SẢN PHẨM --- *@
    <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Ảnh</th>
                    <th>ID</th>
                    <th>Tên Sản phẩm</th>
                    <th>Danh mục</th>
                    <th>Giá (VNĐ)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var product in PagedProducts.Items)
                {
                    <tr>
                        <td>
                            <img src="@product.ImageUrl" alt="@product.Name" style="width: 50px; height: 50px; object-fit: cover;" />
                        </td>
                        <td>@product.Id</td>
                        <td>@product.Name</td>
                        <td>@product.CategoryName</td>
                        <td>@product.Price.ToString("N0")</td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1">Sửa</button>
                            <button class="btn btn-sm btn-danger ms-1" @onclick="() => SoftDeleteProduct(product.Id)">Xóa giả</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @* --- PHẦN PHÂN TRANG (PAGINATION) --- *@
    <div class="d-flex justify-content-between align-items-center mt-3">
        <small class="text-muted">
            Trang @PagedProducts.PageIndex / @PagedProducts.TotalPages | Tổng số @PagedProducts.TotalCount sản phẩm.
        </small>

        <nav aria-label="Page navigation">
            <ul class="pagination mb-0">

                @* Nút Previous *@
                <li class="page-item @(PagedProducts.PageIndex == 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="() => ChangePage(PagedProducts.PageIndex - 1)">Previous</button>
                </li>

                @* Render các Nút số trang *@
                @for (int i = 1; i <= Math.Min(PagedProducts.TotalPages, 5); i++) // Giới hạn 5 nút trang
                {
                    var pageNumber = i;
                    <li class="page-item @(PagedProducts.PageIndex == pageNumber ? "active" : "")">
                        <button class="page-link" @onclick="() => ChangePage(pageNumber)">@pageNumber</button>
                    </li>
                }

                @* Nút Next *@
                <li class="page-item @(PagedProducts.PageIndex == PagedProducts.TotalPages ? "disabled" : "")">
                    <button class="page-link" @onclick="() => ChangePage(PagedProducts.PageIndex + 1)">Next</button>
                </li>
            </ul>
        </nav>
    </div>
}

@code {
    private ProductPerPage? PagedProducts { get; set; }
    private bool IsLoading = true;
    private string? ErrorMessage;

    // Kích thước trang cố định, cần khớp với Server
    private const int PageSize = 10;

    protected override async Task OnInitializedAsync()
    {
        // Tải dữ liệu ban đầu cho trang 1
        await LoadProducts(1);
    }

    private async Task LoadProducts(int pageIndex)
    {
        IsLoading = true;
        ErrorMessage = null;

        try
        {
            // 1. Xây dựng Query String với tham số phân trang
            var queryString = $"api/products?pageIndex={pageIndex}&pageSize={PageSize}";

            // 2. Gọi API và Deserialize sang PagedResponseDto
            var response = await Http.GetAsync(queryString);

            if (response.IsSuccessStatusCode)
            {
                PagedProducts = await response.Content.ReadFromJsonAsync<ProductPerPage>();
            }
            else
            {
                ErrorMessage = $"Lỗi API: {(int)response.StatusCode} {response.ReasonPhrase}";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Lỗi kết nối hoặc xử lý dữ liệu: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
            // Dùng StateHasChanged() để buộc UI render lại
            StateHasChanged();
        }
    }

    private void ChangePage(int newPageIndex)
    {
        if (PagedProducts == null || newPageIndex < 1 || newPageIndex > PagedProducts.TotalPages)
        {
            return;
        }

        // Tải dữ liệu cho trang mới
        _ = LoadProducts(newPageIndex);
    }

    private async Task SoftDeleteProduct(int productId)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Bạn có chắc chắn muốn xóa giả (chuyển vào thùng rác)?");
        if (confirmed)
        {
            // Gọi API DELETE đã được ghi đè logic xóa giả
            var response = await Http.DeleteAsync($"api/products/{productId}");

            if (response.IsSuccessStatusCode)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Sản phẩm đã được chuyển vào thùng rác thành công.");
                // Tải lại trang hiện tại để cập nhật danh sách
                await LoadProducts(PagedProducts?.PageIndex ?? 1);
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Không thể xóa sản phẩm: {response.ReasonPhrase}");
            }
        }
    }
}